/*
 (c) 2015 John Greb, using GPL code from Project Habduino

 HABDuino Tracker
 http://www.habduino.org
 (c) Anthony Stirk M0UPU 
 
 August 2013 Version 1.1
 
 Credits :
 
 GPS Code from jonsowman and Joey flight computer CUSF
 https://github.com/cuspaceflight/joey-m/tree/master/firmware
 
 Thanks to :
 
 Phil Heron
 James Coxon
 Dave Akerman
 
 The UKHAS Community http://ukhas.org.uk
 
 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 
 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
 
 See <http://www.gnu.org/licenses/>.
 */

void sendUBX(char *MSG, short len);

void resetGPS() {
  static char set_reset[] = {
    0xB5, 0x62, 0x06, 0x04, 0x04, 0x00, 0xFF, 0x87, 0x00, 0x00, 0x94, 0xF5 };

  sendUBX(set_reset, sizeof(set_reset));
}

void setNMEAoff() {
   //Turning off all GPS NMEA strings on the uBlox module
  static char setNMEAoff[] = {
    0xB5, 0x62, 0x06, 0x00, 0x14, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD0, 0x08,
    0x00, 0x00, 0x80, 0x25, 0x00, 0x00, 0x07, 0x00, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xA0, 0xA9 };

  sendUBX(setNMEAoff, sizeof(setNMEAoff));
}

void setGLONASSoff() {
  // Disable Glonass for powersaving

#if 1
  static char setgnss[] = { // From HabAXE
    0xB5, 0x62, 0x06, 0x3E, 0x0C, 0x00, 0x00, 0x00,
    0x20, 0x01, 0x06, 0x08, 0x0E, 0x00, 0x00, 0x00,
    0x01, 0x01, 0x00, 0x00 };
#else
  char setgnss[] = { // id,chanMin,chanMax,0,enable,0,flags,0
	0xB5, 0x62, 0x06, 0x3E, 0x2C, 0x00, 0x00, 0x00,
	0x20, 0x05, 0x00, 0x08, 0x10, 0x00, 0x01, 0x00,//gps ON
	0x01, 0x01, 0x01, 0x01, 0x03, 0x00, 0x00, 0x00,//sbas off
	0x01, 0x01, 0x03, 0x08, 0x10, 0x00, 0x00, 0x00,//beidu off
	0x01, 0x01, 0x05, 0x00, 0x03, 0x00, 0x00, 0x00,//qzss off
	0x01, 0x01, 0x06, 0x08, 0x0E, 0x00, 0x00, 0x00,//glonass off
	0x01, 0x01, 0xFC, 0x11 };
#endif
  sendUBX(setgnss, sizeof(setgnss));
}

void setGPS_DynamicMode6()
{
  static char setdm6[] = {
    0xB5, 0x62, 0x06, 0x24, 0x24, 0x00, 0xFF, 0xFF, 0x06,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x10, 0x27, 0x00, 0x00,
    0x05, 0x00, 0xFA, 0x00, 0xFA, 0x00, 0x64, 0x00, 0x2C,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x16, 0xDC };

    sendUBX(setdm6, sizeof(setdm6));
}

void setGPS_DynamicMode3()
{
  static char setdm3[] = {
    0xB5, 0x62, 0x06, 0x24, 0x24, 0x00, 0xFF, 0xFF, 0x03,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x10, 0x27, 0x00, 0x00,
    0x05, 0x00, 0xFA, 0x00, 0xFA, 0x00, 0x64, 0x00, 0x2C,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x76 };

  sendUBX(setdm3, sizeof(setdm3));
}

void setGPS_PowerManagement()
{
  static char setpwrman[] = {
    0xB5, 0x62, 0x06, 0x3B, 0x2C, 0x00, // CFG-PM2, 44bytes
    0x01, 0x00, 0x00, 0x00, 		// version 1
    0x00, 0x01, 0x02, 0x00, 0x00, 0x00, 0x20, 0x00, // limit current, cyclic, 8 seconds 
    0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 16 second aquire
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // padding
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // padding
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // padding
    0x00, 0x00 }; // checksum

  sendUBX(setpwrman, sizeof(setpwrman));
}

void setGPS_MaxPerformance()
{
  static char setMax[] = { 
    0xB5, 0x62, 0x06, 0x11, 0x02, 0x00, 0x08, 0x00, 0x21,
    0x91 }; // Setup for Max Power Mode

  sendUBX(setMax, sizeof(setMax));
}

uint16_t CRC16_checksum (char *string, short len)
{
  uint16_t crc, i, j;
  uint8_t c;

  crc = 0xFFFF;

  // Calculate checksum (NO header chars)
  for (i = 0; i < len; i++)
  {
	c = string[i];
        crc = crc ^ ((uint16_t)c << 8);
        for (j=0; j<8; j++)
        {
            if (crc & 0x8000)
                crc = (crc << 1) ^ 0x1021;
            else
                crc <<= 1;
        }
  }
  return crc;
}

void setGPS_PowerSaveMode()
{
  static char setPSM[] = { 
    0xB5, 0x62, 0x06, 0x11, 0x02, 0x00, 0x08, 0x01, 0x22,
    0x92 }; // CFG-RXM Power Save Mode (Default Cyclic 1s)

  sendUBX(setPSM, sizeof(setPSM));
}

void ublox_pvt()
{
  // Request a NAV-PVT message from the GPS
  static char request[8] = {
    0xB5, 0x62, 0x01, 0x07, 0x00, 0x00, 0x08, 0x19 };

  sendUBX(request, sizeof(request));
}

